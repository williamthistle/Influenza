# CREATE FILE LIST OF FILES FOLLOWING CERTAIN PATTERN
for f in $(find /GlobusCollab/Troyanskaya/MRSA-MSSA/scATAC/ECHO/MSSM_Data_Transfer/Vaccitech_scATAC_Coded -name "fragments.tsv.gz"); do 
    echo "$f" >> filelist.txt;
done

# CREATE FILE LIST OF FILES FOLLOWING CERTAIN PATTERN (MULTIPLE PATTERNS)
for f in $(find /GlobusCollab/Troyanskaya/MRSA-MSSA/scATAC/ECHO/MSSM_Data_Transfer/Vaccitech_Multiome_Coded/*/outs/ -iname "atac_fragments.tsv.gz" -o -iname "atac_fragments.tsv.gz.tbi" -o -iname "raw_feature_bc_matrix.h5" -o -iname "filtered_feature_bc_matrix.h5" -o -iname "per_barcode_metrics.csv" -o -iname "web_summary.html" -o -type d -iname "analysis" -o -type d -iname "raw_feature_bc_matrix" -o -type d -iname "filtered_feature_bc_matrix"); do 
    echo "$f" >> filelist2.txt;
done

# MOVE FILES FROM SERVER TO SERVER
rsync -av --relative --files-from=filelist.txt . wat2@lumos:~/multiome/

# NOT USING ANYTHING BELOW, BUT MAYBE IT'LL COME IN HANDY?

# MERGE BED FILES
cat pre_peaks.bed post_peaks.bed | sort -k1,1 -k2,2n | bedtools merge -i - > merged_peaks.bed

# CONVERT BED TO SAF (for featureCounts)
awk 'OFS="\t" {print $1"."$2+1"."$3, $1, $2+1, $3, "."}' peaks.narrowPeak > peaks.saf

# Convert FRAGMENT BED TO BAM
# hg38.chrom.sizes.txt can be downloaded from https://hgdownload.soe.ucsc.edu/goldenPath/hg38/bigZips/latest/hg38.chrom.sizes
bedtools bedtobam -i ~/scATAC_seq_data/e3e01c75894ef461/outs/fragments.tsv.gz -g hg38.chrom.sizes.txt > ~/scATAC_seq_data/e3e01c75894ef461/outs/test.bam

# I created a bash script which converts all bed to bam using the above command

# RUN FEATURECOUNTS TO GET COUNTS FOR PEAKS
featureCounts -p -O -T 8 -a merged_peaks.saf -F SAF -o merged_featureCounts_output.txt ~/scATAC_seq_data/*/outs/fragments.bam

# REMOVE UNNECESSARY COLUMNS FOR DESEQ2 (ONLY KEEP GENE NAMES AND COUNTS)
cut -f1,7-18 merged_featureCounts_output.txt > merged_featureCounts_output.2.txt